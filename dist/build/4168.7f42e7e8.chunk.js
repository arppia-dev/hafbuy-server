(self.webpackChunke_commerce_server=self.webpackChunke_commerce_server||[]).push([[4168],{94456:u=>{function f(e,s,E,r){for(var c=E-1,O=e.length;++c<O;)if(r(e[c],s))return c;return-1}u.exports=f},97368:(u,f,e)=>{var s=e(12480),E=e(39024),r=e(94456),c=e(85968),O=e(4288),y=Array.prototype,A=y.splice;function B(L,R,U,$){var z=$?r:E,F=-1,H=R.length,_=L;for(L===R&&(R=O(R)),U&&(_=s(L,c(U)));++F<H;)for(var j=0,Q=R[F],v=U?U(Q):Q;(j=z(_,v,j,$))>-1;)_!==L&&A.call(_,j,1),A.call(L,j,1);return L}u.exports=B},92096:(u,f,e)=>{var s=e(12480),E=e(24020),r=e(22488),c=e(75516);function O(y,A){var B=c(y)?s:r;return B(y,E(A,3))}u.exports=O},39620:(u,f,e)=>{var s=e(41912),E=e(35140),r=s(E);u.exports=r},35140:(u,f,e)=>{var s=e(97368);function E(r,c){return r&&r.length&&c&&c.length?s(r,c):r}u.exports=E},96772:(u,f,e)=>{var s=e(35904);function E(r){var c=r==null?0:r.length;return c?s(r,1,c):[]}u.exports=E},54168:(u,f,e)=>{"use strict";e.d(f,{M:()=>oe,ProtectedEditView:()=>je});var s=e(19968),E=e(62552),r=e(84664),c=e(1560),O=e(65080),y=e(23128),A=e(11360),B=e(8612),L=e(37272),R=e(51772),U=e(41868),$=e(10200),z=e(24211),F=e(40960),H=e(64712),_=e(71812),j=e(78164),Q=e(31812),v=e(14632),ee=e(48632),se=e(70516),J=e(49008),te=e(9252),le=e(71944),V=e(63648),W=e(98790),de=e(43164),re=e(18520),ce=e(17200),_e=e(92096),Ee=e(96772),b=e(69372),pe=e(76683),k=e(52540),Oe=e(29088),ne=e(39620),$e=e(17892),Fe=e(31212),He=e(38188),Qe=e(54320),Ve=e(5240),be=e(91892),Ye=e(36196),ze=e(20880),Je=e(21424),Ze=e(18424),Xe=e(21968),we=e(12132),qe=e(85676),es=e(35184),ss=e(99568),ts=e(96556),ns=e(13192),as=e(30840),os=e(77784),is=e(79371),ls=e(67888),ds=e(52600),rs=e(95752),cs=e(37388),_s=e(61840),Es=e(49108),ps=e(44632),Os=e(50840),Ps=e(20252),gs=e(86432),hs=e(22612),Ms=e(24808),us=e(24024),As=e(33656),ms=e(43280),Ds=e(79804),Cs=e(19632),Ts=e(29576),vs=e(61152),xs=e(9589),Is=e(45488),fs=e(75516);const[Pe,ge]=(0,de.G)("ApiTokenPermissionsContext"),he=({children:t,...a})=>(0,s.jsx)(Pe,{...a,children:t}),Z=()=>ge("useApiTokenPermissions"),Me=({errors:t={},onChange:a,canEditInputs:n,isCreating:d,values:o={},apiToken:p={},onDispatch:i,setHasChangedPermissions:x})=>{const{formatMessage:g}=(0,v.c)(),I=({target:{value:C}})=>{x(!1),C==="full-access"&&i({type:"SELECT_ALL_ACTIONS"}),C==="read-only"&&i({type:"ON_CHANGE_READ_ONLY"})},N=[{value:"read-only",label:{id:"Settings.tokens.types.read-only",defaultMessage:"Read-only"}},{value:"full-access",label:{id:"Settings.tokens.types.full-access",defaultMessage:"Full access"}},{value:"custom",label:{id:"Settings.tokens.types.custom",defaultMessage:"Custom"}}];return(0,s.jsx)(r.k,{background:"neutral0",hasRadius:!0,shadow:"filterShadow",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:(0,s.jsxs)(c.C,{direction:"column",alignItems:"stretch",gap:4,children:[(0,s.jsx)(O.O,{variant:"delta",as:"h2",children:g({id:"global.details",defaultMessage:"Details"})}),(0,s.jsxs)(y.y,{gap:5,children:[(0,s.jsx)(A.C,{col:6,xs:12,children:(0,s.jsx)(W.T,{error:t.name,value:o.name,canEditInputs:n,onChange:a})},"name"),(0,s.jsx)(A.C,{col:6,xs:12,children:(0,s.jsx)(W.a,{error:t.description,value:o.description,canEditInputs:n,onChange:a})},"description"),(0,s.jsx)(A.C,{col:6,xs:12,children:(0,s.jsx)(W.L,{isCreating:d,error:t.lifespan,value:o.lifespan,onChange:a,token:p})},"lifespan"),(0,s.jsx)(A.C,{col:6,xs:12,children:(0,s.jsx)(W.b,{value:o.type,error:t.type,label:{id:"Settings.tokens.form.type",defaultMessage:"Token type"},onChange:C=>{I({target:{value:C}}),a({target:{name:"type",value:C}})},options:N,canEditInputs:n})},"type")]})]})})},ue=({apiTokenName:t=null})=>{const{formatMessage:a}=(0,v.c)();return(0,_.G0)(),(0,s.jsxs)(B.G,{"aria-busy":"true",children:[(0,s.jsx)(_.K8,{name:"API Tokens"}),(0,s.jsx)(L.a,{primaryAction:(0,s.jsx)(R.Z,{disabled:!0,startIcon:(0,s.jsx)(re.c,{}),type:"button",size:"L",children:a({id:"global.save",defaultMessage:"Save"})}),title:t||a({id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"})}),(0,s.jsx)(U.S,{children:(0,s.jsx)(_.Wm,{})})]})},Ae=t=>{switch(t){case"POST":return{text:"success600",border:"success200",background:"success100"};case"GET":return{text:"secondary600",border:"secondary200",background:"secondary100"};case"PUT":return{text:"warning600",border:"warning200",background:"warning100"};case"DELETE":return{text:"danger600",border:"danger200",background:"danger100"};default:return{text:"neutral600",border:"neutral200",background:"neutral100"}}},me=(0,b.default)(r.k)`
  margin: -1px;
  border-radius: ${({theme:t})=>t.spaces[1]} 0 0 ${({theme:t})=>t.spaces[1]};
`,De=({route:t={handler:"Nocontroller.error",method:"GET",path:"/there-is-no-path"}})=>{const{formatMessage:a}=(0,v.c)(),{method:n,handler:d,path:o}=t,p=o?Ee(o.split("/")):[],[i="",x=""]=d?d.split("."):[],g=Ae(t.method);return(0,s.jsxs)(c.C,{direction:"column",alignItems:"stretch",gap:2,children:[(0,s.jsxs)(O.O,{variant:"delta",as:"h3",children:[a({id:"Settings.apiTokens.createPage.BoundRoute.title",defaultMessage:"Bound route to"}),"\xA0",(0,s.jsx)("span",{children:i}),(0,s.jsxs)(O.O,{variant:"delta",textColor:"primary600",children:[".",x]})]}),(0,s.jsxs)(c.C,{hasRadius:!0,background:"neutral0",borderColor:"neutral200",gap:0,children:[(0,s.jsx)(me,{background:g.background,borderColor:g.border,padding:2,children:(0,s.jsx)(O.O,{fontWeight:"bold",textColor:g.text,children:n})}),(0,s.jsx)(r.k,{paddingLeft:2,paddingRight:2,children:_e(p,I=>(0,s.jsxs)(O.O,{textColor:I.includes(":")?"neutral600":"neutral900",children:["/",I]},I))})]})]})},Ce=()=>{const{value:{selectedAction:t,routes:a}}=Z(),{formatMessage:n}=(0,v.c)(),d=t?.split(".")[0];return(0,s.jsx)(A.C,{col:5,background:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,style:{minHeight:"100%"},children:t?(0,s.jsx)(c.C,{direction:"column",alignItems:"stretch",gap:2,children:d&&d in a&&a[d].map(o=>o.config.auth?.scope?.includes(t)||o.handler===t?(0,s.jsx)(De,{route:o},o.handler):null)}):(0,s.jsxs)(c.C,{direction:"column",alignItems:"stretch",gap:2,children:[(0,s.jsx)(O.O,{variant:"delta",as:"h3",children:n({id:"Settings.apiTokens.createPage.permissions.header.title",defaultMessage:"Advanced settings"})}),(0,s.jsx)(O.O,{as:"p",textColor:"neutral600",children:n({id:"Settings.apiTokens.createPage.permissions.header.hint",defaultMessage:"Select the application's actions or the plugin's actions and click on the cog icon to display the bound route"})})]})})},ae=(0,b.css)`
  background: ${t=>t.theme.colors.primary100};
  svg {
    opacity: 1;
  }
`,Te=(0,b.default)(r.k)`
  display: flex;
  justify-content: space-between;
  align-items: center;

  svg {
    opacity: 0;
    path {
      fill: ${t=>t.theme.colors.primary600};
    }
  }

  /* Show active style both on hover and when the action is selected */
  ${t=>t.isActive&&ae}
  &:hover {
    ${ae}
  }
`,ve=b.default.div`
  flex: 1;
  align-self: center;
  border-top: 1px solid ${({theme:t})=>t.colors.neutral150};
`,xe=({controllers:t=[],label:a,orderNumber:n=0,disabled:d=!1,onExpanded:o=()=>null,indexExpandendCollapsedContent:p=null})=>{const{value:{onChangeSelectAll:i,onChange:x,selectedActions:g,setSelectedAction:I,selectedAction:N}}=Z(),[C,Y]=E.useState(!1),{formatMessage:G}=(0,v.c)(),h=()=>{Y(P=>!P),o(n)};E.useEffect(()=>{p!==null&&p!==n&&C&&Y(!1)},[p,n,C]);const ie=P=>P===N;return(0,s.jsxs)($.G,{expanded:C,onToggle:h,variant:n%2?"primary":"secondary",children:[(0,s.jsx)(z.M,{title:pe(a)}),(0,s.jsx)(F.u,{children:t?.map(P=>{const K=P.actions.every(M=>g.includes(M.actionId)),X=P.actions.some(M=>g.includes(M.actionId));return(0,s.jsxs)(r.k,{children:[(0,s.jsxs)(c.C,{justifyContent:"space-between",alignItems:"center",padding:4,children:[(0,s.jsx)(r.k,{paddingRight:4,children:(0,s.jsx)(O.O,{variant:"sigma",textColor:"neutral600",children:P?.controller})}),(0,s.jsx)(ve,{}),(0,s.jsx)(r.k,{paddingLeft:4,children:(0,s.jsx)(H.y,{value:K,indeterminate:!K&&X,onValueChange:()=>{i({target:{value:[...P.actions]}})},disabled:d,children:G({id:"app.utils.select-all",defaultMessage:"Select all"})})})]}),(0,s.jsx)(y.y,{gap:4,padding:4,children:P?.actions&&P?.actions.map(M=>(0,s.jsx)(A.C,{col:6,children:(0,s.jsxs)(Te,{isActive:ie(M.actionId),padding:2,hasRadius:!0,children:[(0,s.jsx)(H.y,{value:g.includes(M.actionId),name:M.actionId,onValueChange:()=>{x({target:{value:M.actionId}})},disabled:d,children:M.action}),(0,s.jsx)("button",{type:"button","data-testid":"action-cog",onClick:()=>I({target:{value:M.actionId}}),style:{display:"inline-flex",alignItems:"center"},children:(0,s.jsx)(ce.c,{})})]})},M.actionId))})]},`${a}.${P?.controller}`)})})]})},Ie=({section:t=null,...a})=>{const[n,d]=E.useState(null),o=p=>d(p);return(0,s.jsx)(r.k,{padding:4,background:"neutral0",children:t&&t.map((p,i)=>(0,s.jsx)(xe,{label:p.label,controllers:p.controllers,orderNumber:i,indexExpandendCollapsedContent:n,onExpanded:o,...a},p.apiId))})},fe=({...t})=>{const{value:{data:a}}=Z(),{formatMessage:n}=(0,v.c)();return(0,s.jsxs)(y.y,{gap:0,shadow:"filterShadow",hasRadius:!0,background:"neutral0",children:[(0,s.jsxs)(A.C,{col:7,paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:[(0,s.jsxs)(c.C,{direction:"column",alignItems:"stretch",gap:2,children:[(0,s.jsx)(O.O,{variant:"delta",as:"h2",children:n({id:"Settings.apiTokens.createPage.permissions.title",defaultMessage:"Permissions"})}),(0,s.jsx)(O.O,{as:"p",textColor:"neutral600",children:n({id:"Settings.apiTokens.createPage.permissions.description",defaultMessage:"Only actions bound by a route are listed below."})})]}),a?.permissions&&(0,s.jsx)(Ie,{section:a?.permissions,...t})]}),(0,s.jsx)(Ce,{})]})},ye=k.kt().shape({name:k.Qb().max(100).required(_.aO.required),type:k.Qb().oneOf(["read-only","full-access","custom"]).required(_.aO.required),description:k.Qb().nullable(),lifespan:k.CQ().integer().min(0).nullable().defined(_.aO.required)}),Le=t=>{const a={allActionsIds:[],permissions:[]};return a.permissions=Object.entries(t).map(([n,d])=>({apiId:n,label:n.split("::")[1],controllers:Object.keys(d.controllers).map(o=>({controller:o,actions:o in d.controllers?d.controllers[o].map(p=>{const i=`${n}.${o}.${p}`;return n.includes("api::")&&a.allActionsIds.push(i),{action:p,actionId:i}}).flat():[]})).flat()})),a},Re={data:{allActionsIds:[],permissions:[]},routes:{},selectedAction:"",selectedActions:[]},Ue=(t,a)=>(0,Oe.cp)(t,n=>{switch(a.type){case"ON_CHANGE":{n.selectedActions.includes(a.value)?ne(n.selectedActions,a.value):n.selectedActions.push(a.value);break}case"SELECT_ALL_IN_PERMISSION":{a.value.every(o=>n.selectedActions.includes(o.actionId))?a.value.forEach(o=>{ne(n.selectedActions,o.actionId)}):a.value.forEach(o=>{n.selectedActions.push(o.actionId)});break}case"SELECT_ALL_ACTIONS":{n.selectedActions=[...n.data.allActionsIds];break}case"ON_CHANGE_READ_ONLY":{const d=n.data.allActionsIds.filter(o=>o.includes("find")||o.includes("findOne"));n.selectedActions=[...d];break}case"UPDATE_PERMISSIONS_LAYOUT":{n.data=Le(a.value);break}case"UPDATE_ROUTES":{n.routes={...a.value};break}case"UPDATE_PERMISSIONS":{n.selectedActions=[...a.value];break}case"SET_SELECTED_ACTION":{n.selectedAction=a.value;break}default:return n}}),Be="Name already taken",oe=()=>{(0,_.G0)();const{formatMessage:t}=(0,v.c)(),{lockApp:a,unlockApp:n}=(0,_.H6)(),d=(0,_.eo)(),{state:o}=(0,J.IT)(),p=(0,se.w1)(te.s),[i,x]=E.useState(o?.apiToken?.accessKey?{...o.apiToken}:null),{trackUsage:g}=(0,_.m4)(),{setCurrentStep:I}=(0,_.sg)(),{allowedActions:{canCreate:N,canUpdate:C,canRegenerate:Y}}=(0,_.aU)(p.settings?.["api-tokens"]),[G,h]=E.useReducer(Ue,Re),P=(0,J.SU)("/settings/api-tokens/:id")?.params?.id,{get:K,post:X,put:M}=(0,_.Qn)(),We=(0,J.Uz)(),m=P==="create";(0,ee.useQuery)("content-api-permissions",async()=>{await Promise.all(["/admin/content-api/permissions","/admin/content-api/routes"].map(async l=>{if(l==="/admin/content-api/permissions"){const{data:{data:T}}=await K(l);return h({type:"UPDATE_PERMISSIONS_LAYOUT",value:T}),T}else if(l==="/admin/content-api/routes"){const{data:{data:T}}=await K(l);return h({type:"UPDATE_ROUTES",value:T}),T}})),i&&(i?.type==="read-only"&&h({type:"ON_CHANGE_READ_ONLY"}),i?.type==="full-access"&&h({type:"SELECT_ALL_ACTIONS"}),i?.type==="custom"&&h({type:"UPDATE_PERMISSIONS",value:i?.permissions}))},{onError(){d({type:"warning",message:{id:"notification.error",defaultMessage:"An error occured"}})}}),E.useEffect(()=>{g(m?"didAddTokenFromList":"didEditTokenFromList",{tokenType:V.A})},[m,g]);const{status:Ke}=(0,ee.useQuery)(["api-token",P],async()=>{const{data:{data:l}}=await K(`/admin/api-tokens/${P}`);return x({...l}),l?.type==="read-only"&&h({type:"ON_CHANGE_READ_ONLY"}),l?.type==="full-access"&&h({type:"SELECT_ALL_ACTIONS"}),l?.type==="custom"&&h({type:"UPDATE_PERMISSIONS",value:l?.permissions}),l},{enabled:!m&&!i,onError(){d({type:"warning",message:{id:"notification.error",defaultMessage:"An error occured"}})}}),Se=async(l,T)=>{g(m?"willCreateToken":"willEditToken",{tokenType:V.A}),a();try{const{data:{data:D}}=m?await X("/admin/api-tokens",{...l,lifespan:l.lifespan==="0"?parseInt(l.lifespan):null,permissions:l.type==="custom"?G.selectedActions:null}):await M(`/admin/api-tokens/${P}`,{name:l.name,description:l.description,type:l.type,permissions:l.type==="custom"?G.selectedActions:null});m&&(We.replace(`/settings/api-tokens/${D.id}`,{apiToken:D}),I("apiTokens.success")),n(),x({...D}),d({type:"success",message:t(m?{id:"notification.success.apitokencreated",defaultMessage:"API Token successfully created"}:{id:"notification.success.apitokenedited",defaultMessage:"API Token successfully edited"})}),i?.type&&g(m?"didCreateToken":"didEditToken",{type:i.type,tokenType:V.A})}catch(D){if(D instanceof j.Uh&&D.response){const S=(0,le.f)(D.response.data);T.setErrors(S),D?.response?.data?.error?.message===Be?d({type:"warning",message:D.response.data.message||"notification.error.tokennamenotunique"}):d({type:"warning",message:D?.response?.data?.message||"notification.error"})}n()}},[ke,w]=E.useState(!1),Ne={...G,onChange:({target:{value:l}})=>{w(!0),h({type:"ON_CHANGE",value:l})},onChangeSelectAll:({target:{value:l}})=>{w(!0),h({type:"SELECT_ALL_IN_PERMISSION",value:l})},setSelectedAction:({target:{value:l}})=>{h({type:"SET_SELECTED_ACTION",value:l})}},q=C&&!m||N&&m;return!m&&!i&&Ke!=="success"?(0,s.jsx)(ue,{apiTokenName:i?.name}):(0,s.jsx)(he,{value:Ne,children:(0,s.jsxs)(B.G,{children:[(0,s.jsx)(_.K8,{name:"API Tokens"}),(0,s.jsx)(Q.QJ,{validationSchema:ye,validateOnChange:!1,initialValues:{name:i?.name||"",description:i?.description||"",type:i?.type,lifespan:i?.lifespan?i.lifespan.toString():i?.lifespan},enableReinitialize:!0,onSubmit:(l,T)=>Se(l,T),children:({errors:l,handleChange:T,isSubmitting:D,values:S,setFieldValue:Ge})=>(ke&&S?.type!=="custom"&&Ge("type","custom"),(0,s.jsxs)(_.QF,{children:[(0,s.jsx)(W.F,{backUrl:"/settings/api-tokens",title:{id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"},token:i,setToken:x,canEditInputs:q,canRegenerate:Y,isSubmitting:D,regenerateUrl:"/admin/api-tokens/"}),(0,s.jsx)(U.S,{children:(0,s.jsxs)(c.C,{direction:"column",alignItems:"stretch",gap:6,children:[Boolean(i?.name)&&(0,s.jsx)(W.c,{token:i?.accessKey,tokenType:V.A}),(0,s.jsx)(Me,{errors:l,onChange:T,canEditInputs:q,isCreating:m,values:S,apiToken:i,onDispatch:h,setHasChangedPermissions:w}),(0,s.jsx)(fe,{disabled:!q||S?.type==="read-only"||S?.type==="full-access"})]})})]}))})]})})},je=()=>{const t=(0,se.w1)(te.s);return(0,s.jsx)(_.rF,{permissions:t.settings?.["api-tokens"].read,children:(0,s.jsx)(oe,{})})}}}]);
