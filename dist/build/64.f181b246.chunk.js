"use strict";(self.webpackChunke_commerce_server=self.webpackChunke_commerce_server||[]).push([[64],{20064:(Ts,$,s)=>{s.d($,{ReviewWorkflowsEditPage:()=>_s});var t=s(19968),E=s(62552),G=s(51772),A=s(1560),J=s(33560),R=s(65080),d=s(71812),X=s(18520),b=s(78164),W=s(31812),q=s(35184),ss=s(14632),ts=s(48632),l=s(70516),os=s(49008),es=s(68940),ns=s(50040),e=s(69600),as=s(9252),is=s(17072),h=s(35180),M=s(74556),I=s(48132),ls=s(30320),As=s(38188),Rs=s(54320),Ws=s(5240),Is=s(91892),Bs=s(36196),Us=s(20880),Ks=s(21424),us=s(18424),ws=s(52540),ys=s(21968),js=s(12132),ps=s(85676),xs=s(99568),Ss=s(96556),Fs=s(13192),ks=s(30840),zs=s(77784),Ns=s(79371),Ys=s(67888),Qs=s(52600),Vs=s(95752),Hs=s(37388),Zs=s(61840),$s=s(49108),Gs=s(44632),Js=s(50840),Xs=s(20252),bs=s(86432),qs=s(22612),st=s(24808),tt=s(24024),ot=s(33656),et=s(43280),nt=s(79804),at=s(19632),it=s(29576),lt=s(61152),_t=s(9589),rt=s(45488),Et=s(75516),dt=s(8800),Mt=s(17892),Dt=s(31212);const _s=()=>{const{workflowId:x}=(0,os.W4)(),rs=(0,l.w1)(as.s),{formatMessage:a}=(0,ss.c)(),r=(0,l.OY)(),{put:Es}=(0,d.Qn)(),{formatAPIError:ds}=(0,d.An)(),L=(0,d.eo)(),{isLoading:P,meta:g,workflows:f,refetch:Ms}=(0,ls.u)(),{collectionTypes:S,singleTypes:F,isLoading:B}=(0,ns.u)(),Ds=(0,l.w1)(e.j),Os=(0,l.w1)(e.a),i=(0,l.w1)(e.b),k=(0,l.w1)(e.k),z=(0,l.w1)(e.c),v=(0,l.w1)(e.s),{allowedActions:{canDelete:Ps,canUpdate:U}}=(0,d.aU)(rs.settings?.["review-workflows"]),[C,T]=E.useState({}),{getFeature:gs,isLoading:N}=(0,is.u)(),{isLoading:K,roles:Y}=(0,es.u)(void 0,{retry:!1}),[Q,D]=E.useState(null),[fs,V]=E.useState(),u=f?.find(o=>o.id===parseInt(x,10)),H=f?.filter(o=>o.id!==parseInt(x,10)).flatMap(o=>o.contentTypes),w=gs("review-workflows"),m=w?.[I.C],c=w?.[I.a],{mutateAsync:vs,isLoading:ms}=(0,ts.useMutation)(async({workflow:o})=>{const{data:{data:n}}=await Es(`/admin/review-workflows/workflows/${o.id}`,{data:o});return n},{onSuccess(){L({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}}),cs=async o=>{V(void 0);try{return await vs({workflow:{...o,stages:o.stages?.map(_=>{let O=!0;const j=Ds.workflow?.stages?.find(p=>p.id===_?.id);return j&&(O=j.permissions?.length!==_.permissions?.length||!j.permissions?.every(p=>!!_.permissions?.find(Cs=>Cs.role===p.role))),{..._,permissions:O?_.permissions:void 0}})}})}catch(n){if(n instanceof b.Uh)return n.response&&n.response.data?.error?.name==="ValidationError"&&n.response.data?.error?.details?.errors?.length>0&&V((n.response.data?.error?.details?.errors).reduce((_,O)=>(O.path&&q(_,O.path,O.message),_),{})),L({type:"warning",message:ds(n)}),null}},Z=async()=>{await cs(i),await Ms(),T({})},hs=async()=>{await Z()},Ls=()=>{T({})},y=(0,W.KO)({enableReinitialize:!0,initialErrors:fs,initialValues:i,async onSubmit(){const o=i.contentTypes?.some(n=>H?.includes(n));g&&m&&g?.workflowCount>parseInt(m,10)?D("workflow"):i.stages&&c&&i.stages.length>parseInt(c,10)?D("stage"):k||o?(k&&T(n=>({...n,hasDeletedServerStages:!0})),o&&T(n=>({...n,hasReassignedContentTypes:!0}))):Z()},validate(o){return(0,e.v)({values:o,formatMessage:a})}});return(0,e.u)(I.R,e.i),E.useEffect(()=>(!P&&u&&f&&(r((0,e.l)({workflow:u})),r((0,e.d)({workflows:f}))),B||r((0,e.e)({collectionTypes:S,singleTypes:F})),K||r((0,e.f)(Y)),r((0,e.g)(P||B||K)),()=>{r((0,e.r)())}),[S,r,B,P,K,Y,F,u,f]),E.useEffect(()=>{!P&&!N&&(g&&m&&g?.workflowCount>parseInt(m,10)?D("workflow"):i.stages&&c&&i.stages.length>parseInt(c,10)&&D("stage"))},[i.stages,N,P,w,g,m,c]),E.useEffect(()=>{!v&&z?.length===0&&L({blockTransition:!0,type:"warning",message:a({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[a,v,z,L]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(h.D,{}),(0,t.jsx)(W.uo,{value:y,children:(0,t.jsxs)(W.QF,{onSubmit:y.handleSubmit,children:[(0,t.jsx)(h.H,{navigationAction:(0,t.jsx)(h.B,{href:"/settings/review-workflows"}),primaryAction:U&&(0,t.jsx)(G.Z,{startIcon:(0,t.jsx)(X.c,{}),type:"submit",size:"M",disabled:!Os,loading:!Boolean(Object.keys(C).length>0)&&ms,children:a({id:"global.save",defaultMessage:"Save"})}),subtitle:!v&&a({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:i.stages?.length}),title:i.name||""}),(0,t.jsx)(h.R,{children:v?(0,t.jsx)(A.C,{justifyContent:"center",children:(0,t.jsx)(J.c,{children:a({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})})}):(0,t.jsxs)(A.C,{alignItems:"stretch",direction:"column",gap:7,children:[(0,t.jsx)(e.W,{canUpdate:U}),(0,t.jsx)(e.S,{canDelete:Ps,canUpdate:U,stages:y.values?.stages})]})})]})}),(0,t.jsx)(d.cz.Root,{isConfirmButtonLoading:v,isOpen:Object.keys(C).length>0,onToggleDialog:Ls,onConfirm:hs,children:(0,t.jsx)(d.cz.Body,{children:(0,t.jsxs)(A.C,{direction:"column",gap:5,children:[C.hasDeletedServerStages&&(0,t.jsx)(R.O,{textAlign:"center",variant:"omega",children:a({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})}),C.hasReassignedContentTypes&&(0,t.jsx)(R.O,{textAlign:"center",variant:"omega",children:a({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:H?.filter(o=>i.contentTypes?.includes(o)).length})}),(0,t.jsx)(R.O,{textAlign:"center",variant:"omega",children:a({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"})})]})})}),(0,t.jsxs)(M.L.Root,{isOpen:Q==="workflow",onClose:()=>D(null),children:[(0,t.jsx)(M.L.Title,{children:a({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})}),(0,t.jsx)(M.L.Body,{children:a({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."})})]}),(0,t.jsxs)(M.L.Root,{isOpen:Q==="stage",onClose:()=>D(null),children:[(0,t.jsx)(M.L.Title,{children:a({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})}),(0,t.jsx)(M.L.Body,{children:a({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."})})]})]})}}}]);
